<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Programaci√≥n de Servidores</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;500;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .smooth-transition { transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        .animated-bg {
            background: linear-gradient(-45deg, #0f172a, #1e1b4b, #312e81, #0f172a);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }
        @keyframes gradient { 0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%} }
        .no-scrollbar::-webkit-scrollbar { display:none } .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }
        .custom-scrollbar::-webkit-scrollbar{ width:8px } .custom-scrollbar::-webkit-scrollbar-thumb{ background-color: rgba(99,102,241,0.5); border-radius:4px }
        .custom-scrollbar::-webkit-scrollbar-track{ background-color: rgba(255,255,255,0.05) }
        .blurred { filter: blur(8px) brightness(0.7); transform: scale(0.98); pointer-events: none; }
        .chart-bar-fill { width:0; transition: width 1.5s cubic-bezier(0.22,1,0.36,1); }
        /* tiny avatars */
        .role-badge { font-size: 11px; padding: 2px 6px; border-radius: 999px; }
        .guest-icon { width:38px; height:38px; display:flex; align-items:center; justify-content:center; border-radius:999px; background:rgba(255,255,255,0.03); }
        /* forum/hiring */
        .msg { padding:8px 10px; border-radius:10px; background: rgba(255,255,255,0.03); }
        .msg-admin { background: rgba(236,72,153,0.08); border:1px solid rgba(236,72,153,0.12) }
        .small { font-size:12px }
        .pill { padding:6px 10px; border-radius:999px; background: rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.04) }
    </style>
</head>
<body class="bg-gray-900 text-white h-screen overflow-hidden animated-bg selection:bg-indigo-500 selection:text-white">

<div id="main-canvas" class="h-full w-full flex flex-col smooth-transition origin-center">
    <header class="flex flex-col md:flex-row justify-between items-center px-6 py-5 z-10 gap-4">
        <div class="text-center md:text-left">
            <h1 id="app-title" class="text-3xl md:text-4xl font-extrabold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-cyan-400">Programaci√≥n de Servidores</h1>
            <p id="app-subtitle" class="text-gray-300 text-sm font-medium mt-1 tracking-wide">Niveles de programar. Wiki por Nodropedd_</p>
        </div>
        <div class="flex gap-3 items-center">
            <button onclick="openVersionsModal()" class="group relative p-3 px-4 rounded-full bg-indigo-500/10 hover:bg-indigo-500/20 border border-indigo-400/30 transition-all duration-300 shadow-lg backdrop-blur-md flex items-center gap-2 text-sm font-medium text-indigo-300 hover:text-white">
                <i data-lucide="server" class="w-5 h-5"></i><span id="versions-btn-text">Ver Versiones Core</span>
            </button>

            <!-- replaced "signs" with guest/login icon -->
            <button id="guest-btn" onclick="openLoginModal()" class="guest-icon hover:scale-105 transition-transform" title="Login / Register">
                <span class="text-2xl">üë§</span>
            </button>

            <button onclick="toggleSettings()" class="group relative p-3 rounded-full bg-white/5 hover:bg-white/10 border border-white/10 transition-all duration-300 hover:rotate-90 shadow-lg backdrop-blur-md">
                <i data-lucide="settings" class="w-6 h-6 text-gray-300 group-hover:text-white"></i>
            </button>
        </div>
    </header>

    <main class="flex-grow overflow-y-auto no-scrollbar px-4 pb-10 scroll-smooth">
        <div id="cards-grid" class="container mx-auto grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 p-4"></div>

        <div class="container mx-auto p-4 mt-8 mb-10">
            <h2 class="text-2xl font-bold mb-6 text-center text-indigo-300 border-t border-white/10 pt-8">Gr√°fica de Complejidad T√©cnica</h2>
            <div class="bg-gray-800/50 backdrop-blur-md rounded-3xl p-6 border border-white/5 shadow-2xl">
                <div id="difficulty-chart" class="flex flex-col gap-3"></div>
            </div>
        </div>

        <!-- FORUMS SECTION (not auto-translated content area) -->
        <section id="forums-section" class="container mx-auto p-4 mt-6">
            <div class="bg-gray-800/60 border border-white/5 rounded-2xl p-6 shadow-lg">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <!-- The "forums chat" subtitle translated to Spanish below as requested; the forum content itself is user-generated and not auto-translated -->
                        <h3 class="text-xl font-bold">Forums Chat</h3>
                        <p class="text-sm text-gray-400">Foros - Chat (esta secci√≥n no se traduce autom√°ticamente)</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div id="current-user-badge" class="pill small">Guest</div>
                        <div id="current-user-role" class="role-badge text-xs text-gray-200 hidden"></div>
                        <button class="pill text-sm" onclick="openApplyModal()">Apply for Server Developer</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-2 flex flex-col gap-3">
                        <div id="forum-messages" class="flex flex-col gap-2 max-h-[360px] overflow-y-auto custom-scrollbar p-2 rounded-lg"></div>

                        <div class="flex gap-2 mt-2">
                            <input id="forum-input" placeholder="Write a message..." class="flex-grow px-4 py-2 rounded-xl bg-gray-800/40 border border-white/5 focus:outline-none" />
                            <button id="send-btn" class="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500">Send</button>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">Choose a name and a tiny password in the login/register modal to post messages. Admin "nodropedd" can remove messages.</p>
                    </div>

                    <div class="flex flex-col gap-3">
                        <div class="bg-gray-800/50 rounded-xl p-3 border border-white/5">
                            <h4 class="font-bold">Quick Login</h4>
                            <p class="text-sm text-gray-400">Use the top-right guest icon to login/register. Default admin: nodropedd</p>
                            <div class="flex gap-2 mt-2">
                                <button class="pill" onclick="openLoginModal()">Login / Register</button>
                                <button class="pill" onclick="openApplyModal()">Apply</button>
                            </div>
                        </div>

                        <!-- Hiring Panel -->
                        <div id="hiring-panel" class="bg-gray-800/50 rounded-xl p-3 border border-white/5 flex flex-col gap-3">
                            <div class="flex items-center justify-between">
                                <h4 class="font-bold">Hiring Board</h4>
                                <div class="text-xs text-gray-400">Payments happen outside this website</div>
                            </div>
                            <div id="hiring-list" class="flex flex-col gap-2 max-h-48 overflow-y-auto custom-scrollbar"></div>

                            <div class="flex gap-2">
                                <button id="create-hiring-btn" class="w-full py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500">Create Hiring Post</button>
                            </div>
                            <p class="text-xs text-gray-400">NOTE: Fraud at hiring part will be punished.</p>
                        </div>
                    </div>
                </div>

            </div>
        </section>

    </main>
</div>

<!-- MODALS -->
<!-- Versions Modal -->
<div id="versions-modal" class="fixed inset-0 z-50 flex items-center justify-center opacity-0 pointer-events-none smooth-transition">
    <div onclick="closeAll()" class="absolute inset-0 bg-black/40"></div>
    <div class="bg-gray-800/95 backdrop-blur-xl border border-white/10 rounded-3xl p-6 max-w-4xl w-full mx-4 shadow-2xl transform scale-90 translate-y-4 smooth-transition" id="versions-card">
        <div class="flex justify-between items-start mb-4">
            <div>
                <h2 id="v-title" class="text-2xl font-bold">Versiones y Forks de Servidor</h2>
                <p class="text-sm text-gray-400">APIs y Motores principales de la comunidad.</p>
            </div>
            <button onclick="closeAll()" class="p-2 rounded-full bg-white/5 hover:bg-white/20">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <div class="overflow-auto max-h-[60vh] custom-scrollbar">
            <table class="min-w-full text-sm">
                <thead class="sticky top-0 bg-gray-700/70">
                    <tr class="text-left text-xs text-gray-300 uppercase">
                        <th class="p-3">Nombre</th><th class="p-3 hidden sm:table-cell">Tipo</th><th class="p-3 hidden lg:table-cell">A√±o</th><th class="p-3">Uso Principal</th><th class="p-3 hidden md:table-cell">Curiosidad</th>
                    </tr>
                </thead>
                <tbody id="versions-tbody" class="divide-y divide-white/5"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Detail Modal -->
<div id="detail-modal" class="fixed inset-0 z-50 flex items-center justify-center opacity-0 pointer-events-none smooth-transition">
    <div onclick="closeAll()" class="absolute inset-0 bg-black/40"></div>
    <div class="bg-gray-800/95 backdrop-blur-xl border border-white/10 rounded-3xl p-6 max-w-2xl w-full mx-4 shadow-2xl transform scale-90 translate-y-4 smooth-transition" id="detail-card">
        <div class="flex justify-between items-start mb-4">
            <div>
                <span id="m-level" class="text-xs font-bold uppercase tracking-widest text-indigo-400 mb-1 block">Nivel 1</span>
                <h2 id="m-title" class="text-2xl font-bold text-white">.yml</h2>
                <p id="m-ext" class="text-gray-400 font-mono text-sm mt-1">YAML Configuration</p>
            </div>
            <button onclick="closeAll()" class="p-2 rounded-full bg-white/5 hover:bg-white/20"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <div class="space-y-4">
            <div>
                <h3 id="lbl-whatis" class="text-xs text-gray-500 uppercase font-bold mb-2">Qu√© es</h3>
                <p id="m-whatis" class="text-gray-200 text-sm">Descripci√≥n...</p>
            </div>
            <div>
                <h3 id="lbl-whatdo" class="text-xs text-gray-500 uppercase font-bold mb-2">Qu√© haces</h3>
                <p id="m-whatdo" class="text-gray-200 text-sm">Acci√≥n...</p>
            </div>
            <div>
                <div class="flex justify-between items-end mb-2">
                    <h3 id="lbl-prog" class="text-xs text-gray-500 uppercase font-bold">Nivel de Programaci√≥n</h3>
                    <span id="m-prog-val" class="text-sm font-bold text-indigo-400">Bajo</span>
                </div>
                <div class="h-3 w-full bg-gray-700/50 rounded-full overflow-hidden">
                    <div id="m-bar" class="h-full bg-indigo-500 rounded-full w-0"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div id="settings-modal" class="fixed inset-0 z-50 flex items-center justify-center opacity-0 pointer-events-none smooth-transition">
    <div onclick="closeAll()" class="absolute inset-0"></div>
    <div class="bg-gray-800/90 backdrop-blur-xl border border-white/10 rounded-2xl p-6 w-80 shadow-2xl transform scale-95 smooth-transition" id="settings-card">
        <h3 id="st-title" class="text-xl font-bold mb-4 text-center">Ajustes / Settings</h3>
        <div class="space-y-3">
            <button onclick="changeLang('es')" class="w-full py-3 px-4 rounded-xl flex items-center justify-between bg-white/5 hover:bg-indigo-600/20 border border-white/5 transition-all group">
                <span class="font-medium">Espa√±ol</span> <span id="check-es" class="opacity-100 text-indigo-400"><i data-lucide="check" class="w-4 h-4"></i></span>
            </button>
            <button onclick="changeLang('en')" class="w-full py-3 px-4 rounded-xl flex items-center justify-between bg-white/5 hover:bg-indigo-600/20 border border-white/5 transition-all group">
                <span class="font-medium">English</span> <span id="check-en" class="opacity-0 text-indigo-400"><i data-lucide="check" class="w-4 h-4"></i></span>
            </button>
        </div>
    </div>
</div>

<!-- Login/Register Modal -->
<div id="login-modal" class="fixed inset-0 z-50 flex items-center justify-center opacity-0 pointer-events-none smooth-transition">
    <div onclick="closeAll()" class="absolute inset-0 bg-black/40"></div>
    <div class="bg-gray-800/95 backdrop-blur-xl border border-white/10 rounded-2xl p-6 max-w-md w-full mx-4 shadow-2xl transform scale-90 translate-y-4 smooth-transition" id="login-card">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Login / Register</h3>
            <button onclick="closeAll()" class="p-2 rounded-full bg-white/5 hover:bg-white/20"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>

        <div class="space-y-3">
            <input id="login-name" placeholder="Choose a name (e.g. alice)" class="w-full px-4 py-2 rounded-xl bg-gray-800/40 border border-white/5" />
            <input id="login-pass" placeholder="Tiny password" type="password" class="w-full px-4 py-2 rounded-xl bg-gray-800/40 border border-white/5" />
            <div class="flex gap-2">
                <button class="w-1/2 py-2 rounded-xl bg-indigo-600" onclick="registerUser()">Register</button>
                <button class="w-1/2 py-2 rounded-xl bg-emerald-600" onclick="loginUser()">Login</button>
            </div>
            <p class="text-xs text-gray-400">The user "nodropedd" exists by default as admin. Password can be 'admin' (change later).</p>
        </div>
    </div>
</div>

<!-- Apply Modal -->
<div id="apply-modal" class="fixed inset-0 z-50 flex items-center justify-center opacity-0 pointer-events-none smooth-transition">
    <div onclick="closeAll()" class="absolute inset-0 bg-black/40"></div>
    <div class="bg-gray-800/95 backdrop-blur-xl border border-white/10 rounded-2xl p-6 max-w-lg w-full mx-4 shadow-2xl transform scale-90 translate-y-4 smooth-transition" id="apply-card">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Apply for Server Developer</h3>
            <button onclick="closeAll()" class="p-2 rounded-full bg-white/5 hover:bg-white/20"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <div class="space-y-3">
            <p class="text-sm text-gray-300">Applications will be reviewed by admins. If accepted you'll receive the "server developer" role and permissions to create hiring posts (up to 3 per month).</p>
            <textarea id="apply-msg" rows="5" placeholder="Describe your experience & hourly rate..." class="w-full px-4 py-2 rounded-xl bg-gray-800/40 border border-white/5"></textarea>
            <div class="flex gap-2">
                <button class="w-full py-2 rounded-xl bg-indigo-600" onclick="submitApplication()">Submit Application</button>
            </div>
        </div>
    </div>
</div>

<!-- Create Hiring Modal -->
<div id="create-hiring-modal" class="fixed inset-0 z-50 flex items-center justify-center opacity-0 pointer-events-none smooth-transition">
    <div onclick="closeAll()" class="absolute inset-0 bg-black/40"></div>
    <div class="bg-gray-800/95 backdrop-blur-xl border border-white/10 rounded-2xl p-6 max-w-lg w-full mx-4 shadow-2xl transform scale-90 translate-y-4 smooth-transition" id="create-hiring-card">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Create Hiring Post</h3>
            <button onclick="closeAll()" class="p-2 rounded-full bg-white/5 hover:bg-white/20"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <div class="space-y-3">
            <input id="h-title" placeholder="Title (e.g. 'Full server setup')" class="w-full px-4 py-2 rounded-xl bg-gray-800/40 border border-white/5" />
            <input id="h-price" placeholder="Price (e.g. $50)" class="w-full px-4 py-2 rounded-xl bg-gray-800/40 border border-white/5" />
            <textarea id="h-desc" rows="4" placeholder="Describe services, skills, what you can do..." class="w-full px-4 py-2 rounded-xl bg-gray-800/40 border border-white/5"></textarea>
            <div class="flex gap-2">
                <button class="w-full py-2 rounded-xl bg-emerald-600" onclick="createHiringPost()">Create Post</button>
            </div>
        </div>
    </div>
</div>

<script>
/* ----------------------
   Data & Initial State
   ---------------------- */
const content = {
    es: {
        appTitle: "Programaci√≥n de Servidores",
        appSubtitle: "Niveles de programar de Minecraft. Wiki por Nodropedd_",
        settingsTitle: "Idioma / Language",
        versionsBtn: "Ver Versiones Core"
    },
    en: {
        appTitle: "Server Programming",
        appSubtitle: "Levels of programming of Minecraft. Wiki by Nodropedd_",
        settingsTitle: "Language / Idioma",
        versionsBtn: "View Core Versions"
    }
};

let currentLang = localStorage.getItem('lang') || 'es';
let currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
let users = JSON.parse(localStorage.getItem('users') || 'null');
let messages = JSON.parse(localStorage.getItem('messages') || 'null');
let hiringPosts = JSON.parse(localStorage.getItem('hiringPosts') || 'null');
let applications = JSON.parse(localStorage.getItem('applications') || 'null');

// Initialize storage defaults
if (!users) {
    users = [
        // default admin
        { name: "nodropedd", pass: "admin", role: "admin", postsThisMonth: 0, lastReset: Date.now() }
    ];
    localStorage.setItem('users', JSON.stringify(users));
}
if (!messages) { messages = []; localStorage.setItem('messages', JSON.stringify(messages)); }
if (!hiringPosts) { hiringPosts = []; localStorage.setItem('hiringPosts', JSON.stringify(hiringPosts)); }
if (!applications) { applications = []; localStorage.setItem('applications', JSON.stringify(applications)); }

/* ----------------------
   UI Helpers
   ---------------------- */
function updateHeaderAndLang() {
    document.getElementById('app-title').textContent = content[currentLang].appTitle;
    document.getElementById('app-subtitle').textContent = content[currentLang].appSubtitle;
    document.getElementById('versions-btn-text').textContent = content[currentLang].versionsBtn;
    document.getElementById('check-es').style.opacity = currentLang === 'es' ? 1 : 0;
    document.getElementById('check-en').style.opacity = currentLang === 'en' ? 1 : 0;
}

function saveAll() {
    localStorage.setItem('users', JSON.stringify(users));
    localStorage.setItem('messages', JSON.stringify(messages));
    localStorage.setItem('hiringPosts', JSON.stringify(hiringPosts));
    localStorage.setItem('applications', JSON.stringify(applications));
}

function getUser(name) { return users.find(u => u.name === name); }
function isLogged() { return !!currentUser; }

function refreshUserBadge() {
    const badge = document.getElementById('current-user-badge');
    const roleEl = document.getElementById('current-user-role');
    if (currentUser) {
        badge.textContent = currentUser.name;
        roleEl.textContent = currentUser.role || 'Member';
        roleEl.classList.remove('hidden');
    } else {
        badge.textContent = 'Guest';
        roleEl.classList.add('hidden');
    }
}

/* ----------------------
   Cards & Chart (existing)
   ---------------------- */
// Keep the same levels & serverVersions data used earlier (simplified for brevity)
const levels = [
  { id:0,title:"Comandos",ext:"/setblock /execute",barColor:"bg-gray-500",progress:"2%",color:"text-gray-400",whatIs:"El nivel m√°s b√°sico.",whatDo:"Ejecutar comandos." , prog:"Nula."},
  { id:1,title:".yml",ext:"YAML Config",barColor:"bg-emerald-500",progress:"10%",color:"text-emerald-400",whatIs:"YAML configs.",whatDo:"Editar plugins.",prog:"Muy Baja."},
  { id:2,title:".json",ext:"JSON Data",barColor:"bg-teal-500",progress:"20%",color:"text-teal-400",whatIs:"JSON for datapacks.",whatDo:"Crear loot tables.",prog:"B√°sica."},
  { id:3,title:".toml",ext:"TOML / INI",barColor:"bg-cyan-500",progress:"30%",color:"text-cyan-400",whatIs:"TOML/INI.",whatDo:"Proxies y configs.",prog:"Baja/Media."},
  { id:4,title:".db",ext:"SQL Database",barColor:"bg-sky-500",progress:"40%",color:"text-sky-400",whatIs:"SQL DBs.",whatDo:"Migraciones y queries.",prog:"Intermedia."},
  { id:5,title:"Logic",ext:"ConditionalEvents",barColor:"bg-blue-500",progress:"50%",color:"text-blue-400",whatIs:"L√≥gica condicional.",whatDo:"Sistemas sin Java.",prog:"L√≥gica."},
  { id:6,title:".sk",ext:"Skript Lang",barColor:"bg-indigo-500",progress:"60%",color:"text-indigo-400",whatIs:"Skript.",whatDo:"Minijuegos.",prog:"Alta."},
  { id:7,title:".js",ext:"JavaScript API",barColor:"bg-violet-500",progress:"70%",color:"text-violet-400",whatIs:"JS in server.",whatDo:"Conectar websockets.",prog:"Web."},
  { id:8,title:".lua",ext:"Lua Scripting",barColor:"bg-fuchsia-500",progress:"80%",color:"text-fuchsia-400",whatIs:"Lua.",whatDo:"Automatizaci√≥n.",prog:"Estructurada."},
  { id:9,title:"Java",ext:"Spigot / Paper API",barColor:"bg-rose-500",progress:"90%",color:"text-rose-400",whatIs:"Java plugins.",whatDo:"Plugins profesionales.",prog:"Avanzado."},
  { id:10,title:"Modding",ext:"Forge / Fabric",barColor:"bg-red-600",progress:"100%",color:"text-red-500",whatIs:"Modding.",whatDo:"Agregar bloques/dimensiones.",prog:"Experto."},
  { id:11,title:"Forks / Motor",ext:"Reescribir el Core",barColor:"bg-amber-400",progress:"110%",color:"text-amber-300",whatIs:"Forks.",whatDo:"Modificar el core.",prog:"Maestro."}
];

function populateCards(){
    const grid = document.getElementById('cards-grid');
    grid.innerHTML = '';
    levels.forEach(level => {
        const card = document.createElement('div');
        card.className = 'p-6 rounded-2xl bg-gray-800/50 border border-white/5 shadow-xl cursor-pointer hover:bg-gray-700/60 smooth-transition flex flex-col justify-between';
        card.onclick = ()=> openDetailModal(level);
        card.innerHTML = `
            <div class="flex items-center justify-between">
                <span class="text-xs font-bold uppercase tracking-widest ${level.color}">${(currentLang==='es'?'Nivel':'Level')} ${level.id+1}</span>
                <div class="text-xs font-mono text-gray-400 bg-white/5 px-2 py-1 rounded-full">${level.ext}</div>
            </div>
            <div>
                <h2 class="text-2xl font-extrabold text-white mt-3">${level.title}</h2>
                <p class="text-gray-300 text-sm mt-1">${level.whatIs}</p>
            </div>
            <div class="pt-4 border-t border-white/5">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-xs text-gray-400 uppercase font-medium">${currentLang==='es'?'COMPLEJIDAD T√âCNICA':'TECHNICAL COMPLEXITY'}</span>
                    <span class="text-sm font-bold ${level.color}">${level.prog}</span>
                </div>
                <div class="h-2 w-full bg-gray-700/50 rounded-full overflow-hidden">
                    <div class="h-full ${level.barColor} rounded-full" style="width:${level.progress}"></div>
                </div>
            </div>
        `;
        grid.appendChild(card);
    });
}

function populateChart(){
    const chart = document.getElementById('difficulty-chart');
    chart.innerHTML = '';
    levels.forEach(level=>{
        const row = document.createElement('div');
        row.className='flex items-center gap-4 py-2';
        row.innerHTML = `
            <div class="w-28 text-right text-xs font-medium text-gray-400">${level.title}</div>
            <div class="flex-grow h-4 bg-gray-700/50 rounded-full overflow-hidden border border-white/5">
                <div class="chart-bar-fill h-full ${level.barColor}" style="width:${level.progress}"></div>
            </div>
            <div class="w-10 text-left text-sm font-bold ${level.color}">${level.progress.replace('%','')}</div>
        `;
        chart.appendChild(row);
    });
}

/* ----------------------
   Modals & Detail
   ---------------------- */
const modals = [
    { id: 'versions-modal', cardId: 'versions-card' },
    { id: 'detail-modal', cardId: 'detail-card' },
    { id: 'settings-modal', cardId: 'settings-card' },
    { id: 'login-modal', cardId: 'login-card' },
    { id: 'apply-modal', cardId: 'apply-card' },
    { id: 'create-hiring-modal', cardId: 'create-hiring-card' }
];

function openModal(modalId, cardId){
    document.getElementById('main-canvas').classList.add('blurred');
    const modal = document.getElementById(modalId);
    const card = document.getElementById(cardId);
    modal.classList.remove('opacity-0','pointer-events-none');
    card.classList.remove('scale-90','translate-y-4');
    card.classList.add('scale-100','translate-y-0');
}
function closeAll(){
    document.getElementById('main-canvas').classList.remove('blurred');
    modals.forEach(m=>{
        const modal = document.getElementById(m.id);
        const card = document.getElementById(m.cardId);
        modal.classList.add('opacity-0','pointer-events-none');
        if (card) { card.classList.add('scale-90','translate-y-4'); card.classList.remove('scale-100','translate-y-0'); }
    });
}

function openVersionsModal(){ populateVersionsModal(); openModal('versions-modal','versions-card'); }
function openDetailModal(level){
    document.getElementById('m-level').textContent = `${currentLang==='es'?'Nivel':'Level'} ${level.id+1}`;
    document.getElementById('m-title').textContent = level.title;
    document.getElementById('m-ext').textContent = level.ext;
    document.getElementById('m-whatis').textContent = level.whatIs;
    document.getElementById('m-whatdo').textContent = level.whatDo;
    document.getElementById('m-prog-val').textContent = level.prog;
    const bar = document.getElementById('m-bar');
    bar.style.width = '0%';
    bar.className = `h-full ${level.barColor} rounded-full transition-all`;
    setTimeout(()=> bar.style.width = level.progress, 60);
    openModal('detail-modal','detail-card');
}

function populateVersionsModal(){
    const tbody = document.getElementById('versions-tbody');
    tbody.innerHTML = '';
    const serverVersions = [
        { name: "Bukkit", type: "API", year: 2010, purpose: "API original para plugins.", curiosity: "Desarrollo ces√≥ en 2014." },
        { name: "Spigot", type: "Core", year: 2012, purpose: "Fork de Bukkit optimizado.", curiosity: "Introdujo 'timings'." },
        { name: "Paper", type: "Core", year: 2016, purpose: "Fork de Spigot centrado en rendimiento.", curiosity: "Muy usado hoy en d√≠a." },
        { name: "Purpur", type: "Core", year: 2020, purpose: "Fork con m√°s personalizaci√≥n.", curiosity: "Muchas opciones de config." },
        { name: "Fabric", type: "Modding", year: 2018, purpose: "Plataforma de modding ligera.", curiosity: "Actualizaciones r√°pidas." },
        { name: "Velocity", type: "Proxy", year: 2018, purpose: "Proxy moderno y eficiente.", curiosity: "Multihilo y recomendado." }
    ];
    serverVersions.forEach(v=>{
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-white/3';
        tr.innerHTML = `<td class="p-3 font-bold">${v.name}</td><td class="p-3 hidden sm:table-cell">${v.type}</td><td class="p-3 hidden lg:table-cell">${v.year}</td><td class="p-3 text-xs">${v.purpose}</td><td class="p-3 hidden md:table-cell text-xs italic">${v.curiosity}</td>`;
        tbody.appendChild(tr);
    });
}

/* ----------------------
   Auth: Login / Register
   ---------------------- */
function openLoginModal(){ openModal('login-modal','login-card'); }
function registerUser(){
    const name = (document.getElementById('login-name').value || '').trim();
    const pass = (document.getElementById('login-pass').value || '').trim();
    if (!name || !pass) return alert('Provide name and tiny password.');
    if (getUser(name)) return alert('User exists - please login or choose another name.');
    const usr = { name, pass, role: 'member', postsThisMonth: 0, lastReset: Date.now() };
    users.push(usr);
    saveAll();
    currentUser = { name: usr.name, role: usr.role };
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    refreshUserBadge(); closeAll();
    alert('Registered and logged in as ' + usr.name);
}

function loginUser(){
    const name = (document.getElementById('login-name').value || '').trim();
    const pass = (document.getElementById('login-pass').value || '').trim();
    const u = getUser(name);
    if (!u || u.pass !== pass) return alert('Invalid credentials.');
    currentUser = { name: u.name, role: u.role };
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    refreshUserBadge(); closeAll();
    alert('Welcome back, ' + u.name);
}

/* ----------------------
   Forum Messages
   ---------------------- */
function renderMessages(){
    const container = document.getElementById('forum-messages');
    container.innerHTML = '';
    messages.forEach(m=>{
        const el = document.createElement('div');
        el.className = 'msg flex items-start gap-3';
        if (m.user === 'nodropedd') el.classList.add('msg-admin');
        el.innerHTML = `
            <div class="w-10 flex flex-col items-center">
                <div class="text-lg">${m.user==='nodropedd'?'üëë':'üôÇ'}</div>
                <div class="text-xs text-gray-400">${new Date(m.ts).toLocaleTimeString()}</div>
            </div>
            <div class="flex-1">
                <div class="flex items-center justify-between gap-2">
                    <div>
                        <strong>${m.user}</strong>
                        <span class="text-xs text-gray-400 ml-2">${m.role || 'Member'}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        ${currentUser && (currentUser.role === 'admin' || currentUser.name === m.user) ? `<button class="text-xs text-red-400" onclick="removeMessage('${m.id}')">Remove</button>` : ''}
                    </div>
                </div>
                <div class="mt-1 text-sm">${escapeHtml(m.text)}</div>
            </div>
        `;
        container.appendChild(el);
    });
    container.scrollTop = container.scrollHeight;
}

function sendMessage(){
    const txt = (document.getElementById('forum-input').value || '').trim();
    if (!txt) return;
    if (!currentUser) return alert('Please login/register first (top-right icon).');
    const id = 'm_' + Date.now() + '_' + Math.random().toString(36).slice(2,8);
    const userRecord = getUser(currentUser.name);
    const msg = { id, user: currentUser.name, role: userRecord?.role || 'member', text: txt, ts: Date.now() };
    messages.push(msg); saveAll(); renderMessages();
    document.getElementById('forum-input').value = '';
}

function removeMessage(id){
    if (!currentUser) return alert('Not allowed.');
    const idx = messages.findIndex(m=>m.id===id); if (idx===-1) return;
    // Admin or message owner can remove
    if (currentUser.role === 'admin' || messages[idx].user === currentUser.name) {
        messages.splice(idx,1); saveAll(); renderMessages();
    } else alert('Not permitted.');
}

/* ----------------------
   Hiring Posts & Chats
   ---------------------- */
function renderHiring(){
    const list = document.getElementById('hiring-list');
    list.innerHTML = '';
    hiringPosts.forEach(p=>{
        const el = document.createElement('div');
        el.className = 'bg-gray-900/30 p-3 rounded-lg border border-white/5';
        el.innerHTML = `
            <div class="flex justify-between items-start">
                <div>
                    <div class="font-bold">${escapeHtml(p.title)}</div>
                    <div class="text-xs text-gray-400">${escapeHtml(p.desc)}</div>
                    <div class="text-xs text-gray-300 mt-1">By: <strong>${p.owner}</strong> ‚Äî <span class="text-emerald-400">${p.price}</span></div>
                </div>
                <div class="flex flex-col gap-2">
                    <button class="pill text-sm" onclick="openChatWith('${p.id}')">Chat</button>
                    ${currentUser && (currentUser.role === 'admin' || currentUser.name === p.owner) ? `<button class="pill text-sm text-red-400" onclick="removeHiring('${p.id}')">Remove</button>` : ''}
                </div>
            </div>
        `;
        list.appendChild(el);
    });
}

function openChatWith(postId){
    const post = hiringPosts.find(p=>p.id===postId);
    if(!post) return alert('Post not found');
    const chatId = 'chat_' + postId;
    // Open a prompt-based chat (simple, stored locally)
    const msg = prompt(`Chat with ${post.owner} about "${post.title}". Write your message:`)
    if (!msg) return;
    const chatKey = 'chat_' + postId + '_' + (currentUser ? currentUser.name : 'guest');
    // we'll store messages in messages[] with special type for hiring chats
    messages.push({ id: 'h_' + Date.now(), user: currentUser ? currentUser.name : 'guest', role: currentUser ? currentUser.role : 'guest', text: `[Hiring chat to ${post.owner}] ${msg}`, ts: Date.now() });
    saveAll(); renderMessages(); alert('Message posted in forums (use it to negotiate). Payments outside the site.');
}

function removeHiring(id){
    if (!currentUser) return alert('Not allowed.');
    const idx = hiringPosts.findIndex(h=>h.id===id);
    if (idx===-1) return;
    if (currentUser.role === 'admin' || hiringPosts[idx].owner === currentUser.name) {
        hiringPosts.splice(idx,1); saveAll(); renderHiring();
    } else alert('Not permitted.');
}

function createHiringPost(){
    if (!currentUser) return alert('Login first.');
    const userRec = getUser(currentUser.name);
    if (!userRec) return alert('User record missing.');
    // Enforce role restriction
    if (!(userRec.role === 'server developer' || userRec.role === 'admin')) return alert('Only server developers or admins can create hiring posts.');
    // Reset monthly counter if needed
    const now = Date.now();
    if (!userRec.lastReset || now - userRec.lastReset > 30*24*3600*1000) {
        userRec.postsThisMonth = 0; userRec.lastReset = now;
    }
    if (userRec.postsThisMonth >= 3) return alert('You reached 3 hiring posts this month.');
    const title = (document.getElementById('h-title').value || '').trim();
    const price = (document.getElementById('h-price').value || '').trim();
    const desc = (document.getElementById('h-desc').value || '').trim();
    if (!title || !price || !desc) return alert('Fill title, price and description.');
    const id = 'hp_' + Date.now() + '_' + Math.random().toString(36,8);
    hiringPosts.push({ id, owner: currentUser.name, title, price, desc, ts: Date.now() });
    userRec.postsThisMonth = (userRec.postsThisMonth || 0) + 1;
    saveAll(); renderHiring(); closeAll();
    alert('Hiring post created. Payments outside the website.');
}

/* ----------------------
   Applications (Apply)
   ---------------------- */
function openApplyModal(){ openModal('apply-modal','apply-card'); }
function submitApplication(){
    if (!currentUser) return alert('Login first to apply.');
    const txt = (document.getElementById('apply-msg').value || '').trim();
    if (!txt) return alert('Write some info about your experience & rates.');
    applications.push({ id:'app_'+Date.now(), user: currentUser.name, text: txt, ts: Date.now() });
    saveAll(); closeAll();
    alert('Application submitted. Admins will review and can assign the role.');
}

/* ----------------------
   Admin actions: manage roles
   ---------------------- */
function adminAssignRole(userName, role){
    if (!currentUser || currentUser.role !== 'admin') return alert('Only admins can assign roles.');
    const u = getUser(userName);
    if (!u) return alert('User not found');
    u.role = role;
    saveAll();
    if (currentUser.name === userName) currentUser.role = role;
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    refreshUserBadge(); renderMessages(); renderHiring();
    alert(`Assigned role ${role} to ${userName}`);
}

/* ----------------------
   Utilities & Startup
   ---------------------- */
function escapeHtml(str){ return String(str).replace(/[&<>"'`]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'}[s])); }

document.getElementById('send-btn').addEventListener('click', sendMessage);
document.getElementById('forum-input').addEventListener('keydown', (e)=> { if (e.key === 'Enter') sendMessage(); });
document.getElementById('create-hiring-btn').addEventListener('click', ()=>{
    if (!currentUser) return alert('Login to create a hiring post (server developer or admin).');
    const rec = getUser(currentUser.name);
    if (!(rec && (rec.role==='server developer' || rec.role==='admin'))) return alert('Only server developers or admins can create hiring posts.');
    openModal('create-hiring-modal','create-hiring-card');
});

/* Language change persistence */
function changeLang(lang){ currentLang = lang; localStorage.setItem('lang', lang); updateHeaderAndLang(); populateCards(); populateChart(); }

/* Remove message helper */
window.removeMessage = removeMessage;
window.openChatWith = openChatWith;
window.removeHiring = removeHiring;
window.openApplyModal = openApplyModal;
window.openLoginModal = openLoginModal;
window.openVersionsModal = openVersionsModal;
window.openDetailModal = openDetailModal;
window.adminAssignRole = adminAssignRole;

/* Initialize UI */
function init(){
    updateHeaderAndLang();
    populateCards();
    populateChart();
    refreshUserBadge();
    renderMessages();
    renderHiring();
    lucide.createIcons();
    // Simple keyboard close
    document.addEventListener('keydown', (e)=> { if (e.key === 'Escape') closeAll(); });
}
init();

/* Expose some debug helpers (optional) */
window.createHiringPost = createHiringPost;
window.submitApplication = submitApplication;

/* ----------------------
   Seed sample messages for first load
   ---------------------- */
if (messages.length === 0) {
    messages.push({ id:'m_sys_1', user:'nodropedd', role:'admin', text: 'Welcome to Forums Chat! Admin can remove messages and manage roles.', ts: Date.now() });
    saveAll(); renderMessages();
}

/* ----------------------
   Translation of user's instruction (requested)
   ---------------------- */
/* The following are translations of the user's last request.
   English (as you asked) and Spanish translations are provided below.
   These are just literal translations of the instruction text and are not used anywhere in the UI automatically.
*/

/* ENGLISH:
On English it says "Niveles de programar. Wiki por Nodropedd_" ‚Äî make that it says in English:
"Levels of programming of Minecraft. Wiki by Nodropedd_".
Also in Spanish say: "Niveles de programar de Minecraft. Wiki por Nodropedd_".

Add a forums part which isn't automatically translated (obviously). If you scroll down you can see forums chat (also translated to Spanish the "forums chat" subtitle) and you can type a message. You must choose a name and a tiny password or login with a name and password. The user called "nodropedd" will be admin and able to remove messages from forums. Replace the current sign-in button with a guest emoji icon that opens login/register. When logged in you can change language and see your role: "Member" or "admin" or "server developer". Make the admin be able to remove messages and assign/remove roles. Add a button for "Apply for server developer" which will give access to be paid for making servers and not be punished, and add announcements at the Hiring part (to be explained later). Add a special role and note: "fraud at hiring part will be punished". For the hiring part, people can search for a dev to hire; the dev will list prices and capabilities and can chat with them. People can hire a developer by chatting and agreeing a trade; users with "server developer" or "admin" roles can create up to 3 hiring posts per month. Admins can also remove hiring posts. Payments happen outside the website (they pay in chat). Finally translate what I said to Spanish and English.
*/

/* SPANISH:
En ingl√©s aparece "Niveles de programar. Wiki por Nodropedd_" ‚Äî haz que en ingl√©s diga:
"Levels of programming of Minecraft. Wiki by Nodropedd_".
Adem√°s en espa√±ol debe decir: "Niveles de programar de Minecraft. Wiki por Nodropedd_".

A√±ade una secci√≥n de foros que no se traduzca autom√°ticamente (obviamente). Si te desplazas hacia abajo ver√°s el chat de foros (tambi√©n traducido al espa√±ol el subt√≠tulo "forums chat") y podr√°s escribir lo que quieras. Tienes que elegir un nombre y una contrase√±a peque√±a o iniciar sesi√≥n con un nombre y contrase√±a. El usuario llamado "nodropedd" ser√° administrador y podr√° eliminar mensajes de los foros. Sustituye el bot√≥n de inicio de sesi√≥n actual por un icono emoji de invitado que abra iniciar sesi√≥n/registrarse. Al iniciar sesi√≥n podr√°s cambiar el idioma y ver tu rol: "Member", "admin" o "server developer". Haz que el administrador pueda eliminar mensajes y asignar/quitar roles. A√±ade un bot√≥n para "Apply for Server Developer" que te dar√° acceso para cobrar por hacer servidores y no ser castigado, y a√±ade anuncios en la secci√≥n de contrataci√≥n que explicar√°s despu√©s. A√±ade un rol especial y debajo una NOTA: "fraude en la secci√≥n de contrataci√≥n ser√° castigado". En la parte de contrataci√≥n, la gente puede buscar a un desarrollador para contratar; el desarrollador podr√° mostrar precios y qu√© puede hacer y chatear con √©l. La gente puede contratar al desarrollador chateando y acordando un trato justo. Usuarios con rol "server developer" o "admin" podr√°n crear hasta 3 anuncios de contrataci√≥n por mes. El administrador tambi√©n podr√° eliminar anuncios de contrataci√≥n. Los pagos ser√°n fuera de la web (se pagar√° por chat). Finalmente, traduce lo que dije al espa√±ol e ingl√©s.
*/

</script>
</body>
</html>
